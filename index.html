<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <!-- iOS fullscreen -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tea Timer">

  <!-- iOS icons -->
  <link rel="apple-touch-icon" sizes="180x180" href="gaiwan-180.png">
  <link rel="apple-touch-icon" sizes="167x167" href="gaiwan-167.png">
  <link rel="apple-touch-icon" sizes="152x152" href="gaiwan-152.png">

  <!-- Prevent text scaling -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <link rel="manifest" href="manifest.json">

  <title>Tea Timer</title>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: black;
      color: white;
      font-family: "HelveticaNeue-Light", "Helvetica Neue Light",
        "Helvetica Neue", Helvetica, Arial, sans-serif;
      touch-action: manipulation;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    #top-bar {
      display: flex;
      justify-content: space-between;
      padding: 10px;
      z-index: 2;
    }

    select {
      background: black;
      color: #ccc;
      border: none;
      font-size: 24px;
      padding: 6px 25px 6px 8px;
      font-family: inherit;
      letter-spacing: 1px;
      -webkit-appearance: none;
      appearance: none;
      min-width: 240px;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23ccc'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 5px center;
      background-size: 24px;
      outline: none;
    }

    select option {
      background: black;
      color: #ccc;
    }

    #center {
      flex: 1;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      user-select: none;
    }

    #temperature {
      z-index: 1;
      letter-spacing: 1px;
    }

    #timer {
      display: flex;
      align-items: center;
      font-family: "HelveticaNeue-UltraLight", "Helvetica Neue", Helvetica, Arial, sans-serif;
      font-weight: 100;
      letter-spacing: 2px;
      z-index: 1;
    }

    .digits {
      display: inline-block;
      min-width: 2ch;
      text-align: center;
    }

    .colon {
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 0.24em;
      margin: 0 0.2em;
    }

    .colon span {
      width: 0.06em;
      height: 0.06em;
      background: white;
      border-radius: 50%;
      opacity: 0.9;
    }

    #temperature {
      margin-bottom: 6px;
      letter-spacing: 1px;
    }

    #progressRing {
      position: absolute;
      overflow: visible;
    }


    /* Glow animation */
    #ringGlow {
      opacity: 0;
    }

    .pulse {
      animation: glowPulse var(--pulse-duration) ease-out forwards;
    }

    @keyframes glowPulse {
      0% {
        opacity: 0;
      }

      8% {
        opacity: var(--pulse-opacity);
      }

      100% {
        opacity: 0;
      }
    }
  </style>
</head>

<body>

  <div id="top-bar">
    <select id="teaSelect"></select>
    <select id="steepSelect"></select>
  </div>

  <div id="center">
    <svg id="progressRing"></svg>
    <div id="temperature">— °C</div>

    <div id="timer">
      <span class="digits" id="mm">00</span>
      <span class="colon"><span></span><span></span></span>
      <span class="digits" id="ss">00</span>
    </div>
  </div>

  <script type="module">
    /* ================= CONFIG ================= */

    // Tea data - will be loaded from external module or use fallback
    let TEAS = {};

    // Try to load tea data from external module, fallback to inline if it fails
    async function loadTeas() {
      try {
        const module = await import('./teas.js');
        TEAS = module.TEAS;
      } catch (error) {
        console.warn('Could not load teas.js (probably running from file://), using fallback data');
        // Fallback tea data for file:// usage
        TEAS = {
          "Fallback 1": {
            color: "#d1e576",
            temperatures: [75, 75, 75],
            times: ["01:00", "00:01", "00:45"]
          },
          "Fallback 2": {
            color: "#f8e367",
            temperatures: Array(10).fill(75),
            times: Array(10).fill("00:15")
          }
        };
      }
    }


    const RING_SCALE = 0.75;
    const TIMER_FONT_SCALE = 0.20;
    const TEMP_FONT_SCALE = TIMER_FONT_SCALE * 0.5;

    /* Glow */
    const START_PULSE_DURATION = 2500;
    const START_PULSE_OPACITY = 0.6;
    const GLOW_BLUR = 6;
    const GLOW_PADDING_MULT = 3;


    /* ================= Gong effect ========= */
    const GONG_VOLUME = 0.4;   // configurable
    const GONG_ENABLED = true;

    const gong = new Audio("gong.m4a");
    gong.preload = "auto";
    gong.volume = GONG_VOLUME;

    let audioUnlocked = false;

    function unlockAudio() {
      if (audioUnlocked) return;

      const silent = new Audio();
      silent.src =
        "data:audio/mp3;base64,//uQxAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAACcQCA...";
      silent.play().then(() => {
        audioUnlocked = true;
      }).catch(() => {});
    }
    /* ================= STATE ================= */

    let currentTea, currentSteep, totalSteeps;
    let totalSeconds = 0;
    let startTime = null;
    let animFrame = null;
    let state = "ready";

    /* ================= ELEMENTS ================= */

    const teaSelect = document.getElementById("teaSelect");
    const steepSelect = document.getElementById("steepSelect");
    const mmEl = document.getElementById("mm");
    const ssEl = document.getElementById("ss");
    const temperatureEl = document.getElementById("temperature");
    const progressRing = document.getElementById("progressRing");

    /* ================= RING ================= */

    let ringBase, ringProgress, ringGlow;
    let RADIUS, CIRC, STROKE;

    function buildRing() {
      const base = Math.min(innerWidth, innerHeight) * RING_SCALE;
      STROKE = base * 0.015;
      RADIUS = (base - STROKE) / 2;
      CIRC = 2 * Math.PI * RADIUS;

      const pad = STROKE * GLOW_PADDING_MULT;
      const size = base + pad * 2;
      const c = size / 2;

      progressRing.setAttribute("width", size);
      progressRing.setAttribute("height", size);
      progressRing.setAttribute("viewBox", `0 0 ${size} ${size}`);

      progressRing.innerHTML = `
<defs>
  <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
    <feGaussianBlur stdDeviation="${GLOW_BLUR}" />
  </filter>
</defs>

<circle cx="${c}" cy="${c}" r="${RADIUS}"
  stroke-width="${STROKE}" fill="none" id="ringBase"/>

<circle cx="${c}" cy="${c}" r="${RADIUS}"
  stroke-width="${STROKE * 2.6}" fill="none"
  id="ringGlow" filter="url(#glow)"/>

<circle cx="${c}" cy="${c}" r="${RADIUS}"
  stroke="#555" stroke-width="${STROKE}" fill="none"
  stroke-dasharray="${CIRC}"
  transform="rotate(90 ${c} ${c}) scale(-1 1) translate(${-size} 0)"
  id="ringProgress"/>
`;

      ringBase = document.getElementById("ringBase");
      ringGlow = document.getElementById("ringGlow");
      ringProgress = document.getElementById("ringProgress");

      setProgress(0);

      document.getElementById("timer").style.fontSize =
        `${base * TIMER_FONT_SCALE}px`;
      temperatureEl.style.fontSize =
        `${base * TEMP_FONT_SCALE}px`;
    }

    function setProgress(f) {
      ringProgress.style.strokeDashoffset = CIRC * (1 - f);
    }

    /* ================= TIMER ================= */

    function renderTime(sec) {
      sec = Math.max(0, Math.floor(sec));
      mmEl.textContent = String(Math.floor(sec / 60)).padStart(2, "0");
      ssEl.textContent = String(sec % 60).padStart(2, "0");
    }

    function startPulse(color) {
      ringGlow.style.stroke = color;

      ringGlow.style.setProperty("--pulse-duration", `${START_PULSE_DURATION}ms`);
      ringGlow.style.setProperty("--pulse-opacity", START_PULSE_OPACITY);

      ringGlow.setAttribute("filter", "url(#glow)");

      ringGlow.classList.remove("pulse");

      void ringGlow.getBBox(); // force SVG reflow (important!)
      ringGlow.classList.add("pulse");
    }

    /* ================= LOGIC ================= */

    function prepareSteep(i) {
      cancelAnimationFrame(animFrame);
      state = "ready";
      currentSteep = i;

      const tea = TEAS[currentTea];
      totalSeconds = parseTime(tea.times[i]);
      renderTime(totalSeconds);

      temperatureEl.textContent = tea.temperatures[i] + " °C";
      ringBase.style.stroke = tea.color;
      ringGlow.style.stroke = tea.color;
      setProgress(0);
	  
      updateSteepMenu();
    }

    function startSteep() {
      if (state !== "ready") return;
      state = "running";

	  unlockAudio();

      if (GONG_ENABLED) {
        gong.currentTime = 0;
        gong.play().catch(() => {
          /* autoplay rejected — safe to ignore */
        });
      }

      renderTime(totalSeconds);

      startPulse(TEAS[currentTea].color);
      startTime = performance.now();

      function tick(now) {
        const elapsed = (now - startTime) / 1000;
        const remaining = totalSeconds - elapsed;
        const frac = Math.min(elapsed / totalSeconds, 1);

        renderTime(remaining);
        setProgress(frac);

        if (remaining <= 0) {
          finishSteep();
        } else {
          animFrame = requestAnimationFrame(tick);
        }
      }
      animFrame = requestAnimationFrame(tick);
    }

    function finishSteep() {
      cancelAnimationFrame(animFrame);
      setProgress(1);

      if (currentSteep < totalSteeps - 1) {
        setTimeout(() => prepareSteep(currentSteep + 1), 400);
      }
    }

    /* ================= UI ================= */

    function updateSteepMenu() {
      steepSelect.innerHTML = "";
      const tea = TEAS[currentTea];
      tea.times.forEach((t, i) => {
        const o = document.createElement("option");
        o.value = i;
        o.textContent = `${i + 1} of ${totalSteeps} (${tea.times[i]})`;
        steepSelect.appendChild(o);
      });
      steepSelect.value = currentSteep;
    }

    const parseTime = t => {
      const [m, s] = t.split(":").map(Number);
      return m * 60 + s;
    };

    /* ================= EVENTS ================= */

	document.getElementById("center").addEventListener("pointerdown", startSteep);
	document.getElementById("center").addEventListener("pointerdown", () => { unlockAudio(); }, { once: true });
    teaSelect.addEventListener("change", () => {
      currentTea = teaSelect.value;
      totalSteeps = TEAS[currentTea].times.length;
      prepareSteep(0);
    });
    steepSelect.addEventListener("change", () =>
      prepareSteep(+steepSelect.value)
    );

    window.addEventListener("resize", buildRing);

    /* ================= INIT ================= */

    async function initializeApp() {
      await loadTeas();

      Object.keys(TEAS).forEach(t => {
        const o = document.createElement("option");
        o.value = o.textContent = t;
        teaSelect.appendChild(o);
      });

      buildRing();
      currentTea = teaSelect.value = Object.keys(TEAS)[0];
      totalSteeps = TEAS[currentTea].times.length;
      prepareSteep(0);
    }

    // Initialize the app
    initializeApp();
  </script>

</body>

</html>